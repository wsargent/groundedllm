# Additional caching rules for GroundedLLM

# Cache control headers
proxy_ignore_headers X-Accel-Expires Expires Cache-Control;

# Don't cache requests with authentication
map $http_authorization $skip_cache {
    default 1;
    "" 0;
}

# Don't cache streaming requests
map $http_accept $skip_streaming_cache {
    "~*text/event-stream" 1;
    default 0;
}

# Forward proxy setup for Hayhooks external content
server {
    listen 8888;
    
    # Access log with cache status
    access_log /var/log/nginx/proxy_access.log main;
    
    # Resolver for DNS lookups
    resolver 8.8.8.8 ipv6=off;
    
    # Proxy settings
    location / {
        proxy_pass $scheme://$host$request_uri;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Caching settings for external content
        proxy_cache external_cache;
        proxy_cache_valid 200 302 24h;
        proxy_cache_valid 404 30m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        add_header X-Cache-Status $upstream_cache_status;
        
        # Skip cache for certain conditions
        proxy_cache_bypass $skip_cache $skip_streaming_cache;
        
        # Set appropriate timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Enable HTTP/2
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
